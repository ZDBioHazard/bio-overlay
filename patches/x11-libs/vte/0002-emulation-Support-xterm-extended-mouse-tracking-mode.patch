From cfa165e122bff67a164fa9f37584e8f5a6d54970 Mon Sep 17 00:00:00 2001
From: Egmont Koblinger <egmont@gmail.com>
Date: Tue, 21 Aug 2012 00:33:26 +0200
Subject: [PATCH 2/2] emulation: Support xterm extended mouse tracking mode

https://bugzilla.gnome.org/show_bug.cgi?id=681329

diff --git a/src/mev.c b/src/mev.c
index f6817e1..6306512 100644
--- a/src/mev.c
+++ b/src/mev.c
@@ -42,7 +42,9 @@ static enum {
 	tracking_mouse = 1000,
 	tracking_hilite = 1001,
 	tracking_cell_motion = 1002,
-	tracking_all_motion = 1003
+	tracking_all_motion = 1003,
+	tracking_xterm_ext = 1006,
+	tracking_urxvt = 1015
 } tracking_mode = 0;
 
 static void
@@ -59,6 +61,8 @@ reset(void)
 	decset(tracking_hilite, FALSE);
 	decset(tracking_cell_motion, FALSE);
 	decset(tracking_all_motion, FALSE);
+	decset(tracking_xterm_ext, FALSE);
+	decset(tracking_urxvt, FALSE);
 	fflush(stdout);
 }
 
@@ -93,6 +97,14 @@ clear(void)
 		fprintf(stdout, "All motion tracking enabled.\r\n");
 		decset(tracking_all_motion, TRUE);
 		break;
+	case tracking_xterm_ext:
+		fprintf(stdout, "Xterm 1006 mouse tracking extension enabled.\r\n");
+		decset(tracking_xterm_ext, TRUE);
+		break;
+	case tracking_urxvt:
+		fprintf(stdout, "rxvt-unicode 1015 mouse tracking extension enabled.\r\n");
+		decset(tracking_urxvt, TRUE);
+		break;
 	default:
 		fprintf(stdout, "Tracking disabled.\r\n");
 		break;
@@ -102,6 +114,8 @@ clear(void)
 	fprintf(stdout, "C - Hilite tracking [FIXME: NOT IMPLEMENTED].\r\n");
 	fprintf(stdout, "D - Cell motion tracking.\r\n");
 	fprintf(stdout, "E - All motion tracking.\r\n");
+	fprintf(stdout, "F - Xterm 1006 extension.\r\n");
+	fprintf(stdout, "G - rxvt-unicode extension.\r\n");
 	fprintf(stdout, "%s", _VTE_CAP_ESC "8");
 	fflush(stdout);
 }
@@ -153,6 +167,18 @@ parse(void)
 					0 : tracking_all_motion;
 			i++;
 			break;
+		case 'F':
+		case 'f':
+			tracking_mode = (tracking_mode == tracking_xterm_ext) ?
+					0 : tracking_xterm_ext;
+			i++;
+			break;
+		case 'G':
+		case 'g':
+			tracking_mode = (tracking_mode == tracking_urxvt) ?
+					0 : tracking_urxvt;
+			i++;
+			break;
 		case 'Q':
 		case 'q':
 			ret = TRUE;
diff --git a/src/vte-private.h b/src/vte-private.h
index b56cc89..2d5d923 100644
--- a/src/vte-private.h
+++ b/src/vte-private.h
@@ -305,6 +305,7 @@ struct _VteTerminalPrivate {
 	long mouse_last_x, mouse_last_y;
 	gboolean mouse_autohide;
 	guint mouse_autoscroll_tag;
+	gboolean mouse_xterm_extension;
 	gboolean mouse_urxvt_extension;
 
 	/* State variables for handling match checks. */
diff --git a/src/vte.c b/src/vte.c
index 3ba47a9..7425bd6 100644
--- a/src/vte.c
+++ b/src/vte.c
@@ -5816,22 +5816,20 @@ vte_terminal_paste_cb(GtkClipboard *clipboard, const gchar *text, gpointer data)
 }
 
 static void
-vte_terminal_get_mouse_tracking_info (VteTerminal   *terminal,
-				      int            button,
-				      long           col,
-				      long           row,
-				      unsigned char *pb,
-				      long          *px,
-				      long          *py)
+vte_terminal_feed_mouse_event(VteTerminal *terminal,
+			      int          button,
+			      gboolean     is_drag,
+			      gboolean     is_release,
+			      long         col,
+			      long         row)
 {
 	unsigned char cb = 0;
 	long cx, cy;
+	char buf[LINE_MAX];
+	gint len = 0;
 
 	/* Encode the button information in cb. */
 	switch (button) {
-	case 0:			/* Release/no buttons. */
-		cb = 3;
-		break;
 	case 1:			/* Left. */
 		cb = 0;
 		break;
@@ -5848,7 +5846,12 @@ vte_terminal_get_mouse_tracking_info (VteTerminal   *terminal,
 		cb = 65;	/* Scroll down. */
 		break;
 	}
-	cb += 32; /* 32 for normal */
+
+	/* With the exception of the 1006 mode, button release is also encoded here. */
+	/* Note that if multiple extensions are enabled, the 1006 is used, so it's okay to check for only that. */
+	if (is_release && !terminal->pvt->mouse_xterm_extension) {
+		cb = 3;
+	}
 
 	/* Encode the modifiers. */
 	if (terminal->pvt->modifiers & GDK_SHIFT_MASK) {
@@ -5861,32 +5864,27 @@ vte_terminal_get_mouse_tracking_info (VteTerminal   *terminal,
 		cb |= 16;
 	}
 
-	/* Clamp the cursor coordinates. */
+	/* Encode a drag event. */
+	if (is_drag) {
+		cb |= 32;
+	}
+
+	/* Clamp the cursor coordinates. Make them 1-based. */
 	cx = CLAMP(1 + col,
 		   1, terminal->column_count);
 	cy = CLAMP(1 + row,
 		   1, terminal->row_count);
 
-	*pb = cb;
-	*px = cx;
-	*py = cy;
-}
-
-static void
-vte_terminal_feed_mouse_event(VteTerminal *terminal,
-                              int          cb,
-                              long         cx,
-                              long         cy)
-{
-	char buf[LINE_MAX];
-	gint len = 0;
-
-	if (terminal->pvt->mouse_urxvt_extension) {
+	/* Check the extensions in decreasing order of preference. Encoding the release event above assumes that 1006 comes first. */
+	if (terminal->pvt->mouse_xterm_extension) {
+		/* xterm's extended mode (1006) */
+		len = g_snprintf(buf, sizeof(buf), _VTE_CAP_CSI "<%d;%ld;%ld%c", cb, cx, cy, is_release ? 'm' : 'M');
+	} else if (terminal->pvt->mouse_urxvt_extension) {
 		/* urxvt's extended mode (1015) */
-		len = g_snprintf(buf, sizeof(buf), _VTE_CAP_CSI "%d;%ld;%ldM", cb, cx, cy);
+		len = g_snprintf(buf, sizeof(buf), _VTE_CAP_CSI "%d;%ld;%ldM", 32 + cb, cx, cy);
 	} else if (cx <= 231 && cy <= 231) {
 		/* legacy mode */
-		len = g_snprintf(buf, sizeof(buf), _VTE_CAP_CSI "M%c%c%c", cb, 32 + (guchar)cx, 32 + (guchar)cy);
+		len = g_snprintf(buf, sizeof(buf), _VTE_CAP_CSI "M%c%c%c", 32 + cb, 32 + (guchar)cx, 32 + (guchar)cy);
 	}
 
 	/* Send event direct to the child, this is binary not text data */
@@ -5896,20 +5894,16 @@ vte_terminal_feed_mouse_event(VteTerminal *terminal,
 static void
 vte_terminal_send_mouse_button_internal(VteTerminal *terminal,
 					int          button,
+					gboolean     is_release,
 					long         x,
 					long         y)
 {
-	unsigned char cb;
-	long cx, cy;
 	int width = terminal->char_width;
 	int height = terminal->char_height;
 	long col = (x - terminal->pvt->inner_border.left) / width;
 	long row = (y - terminal->pvt->inner_border.top) / height;
 
-	vte_terminal_get_mouse_tracking_info (terminal,
-					      button, col, row,
-					      &cb, &cx, &cy);
-	vte_terminal_feed_mouse_event(terminal, cb, cx, cy);
+	vte_terminal_feed_mouse_event(terminal, button, FALSE /* not drag */, is_release, col, row);
 }
 
 /* Send a mouse button click/release notification. */
@@ -5937,7 +5931,8 @@ vte_terminal_maybe_send_mouse_button(VteTerminal *terminal,
 	}
 
 	vte_terminal_send_mouse_button_internal(terminal,
-					        (event->type == GDK_BUTTON_PRESS) ? event->button : 0,
+						event->button,
+						event->type == GDK_BUTTON_RELEASE,
 						event->x, event->y);
 }
 
@@ -5945,8 +5940,6 @@ vte_terminal_maybe_send_mouse_button(VteTerminal *terminal,
 static void
 vte_terminal_maybe_send_mouse_drag(VteTerminal *terminal, GdkEventMotion *event)
 {
-	unsigned char cb;
-	long cx, cy;
 	int width = terminal->char_width;
 	int height = terminal->char_height;
 	long col = ((long) event->x - terminal->pvt->inner_border.left) / width;
@@ -5975,12 +5968,9 @@ vte_terminal_maybe_send_mouse_drag(VteTerminal *terminal, GdkEventMotion *event)
 		break;
 	}
 
-	vte_terminal_get_mouse_tracking_info (terminal,
-					      terminal->pvt->mouse_last_button, col, row,
-					      &cb, &cx, &cy);
-	cb += 32; /* for movement */
-
-	vte_terminal_feed_mouse_event(terminal, cb, cx, cy);
+	vte_terminal_feed_mouse_event(terminal, terminal->pvt->mouse_last_button,
+				      TRUE /* drag */, FALSE /* not release */,
+				      col, row);
 }
 
 /* Clear all match hilites. */
@@ -11406,6 +11396,7 @@ vte_terminal_scroll(GtkWidget *widget, GdkEventScroll *event)
 			/* Encode the parameters and send them to the app. */
 			vte_terminal_send_mouse_button_internal(terminal,
 								button,
+								FALSE /* not release */,
 								event->x,
 								event->y);
 		}
@@ -14115,6 +14106,7 @@ vte_terminal_reset(VteTerminal *terminal,
 	pvt->mouse_last_button = 0;
 	pvt->mouse_last_x = 0;
 	pvt->mouse_last_y = 0;
+	pvt->mouse_xterm_extension = FALSE;
 	pvt->mouse_urxvt_extension = FALSE;
 	/* Clear modifiers. */
 	pvt->modifiers = 0;
diff --git a/src/vteseq.c b/src/vteseq.c
index d850929..de6c5d8 100644
--- a/src/vteseq.c
+++ b/src/vteseq.c
@@ -685,6 +685,11 @@ vte_sequence_handler_decset_internal(VteTerminal *terminal,
 		 GINT_TO_POINTER(0),
 		 GINT_TO_POINTER(MOUSE_TRACKING_ALL_MOTION_TRACKING),
 		 NULL, NULL,},
+		/* 1006: Extended mouse coordinates. */
+		{1006, &terminal->pvt->mouse_xterm_extension, NULL, NULL,
+		 GINT_TO_POINTER(FALSE),
+		 GINT_TO_POINTER(TRUE),
+		 NULL, NULL,},
 		/* 1010/rxvt: disallowed, scroll-on-output is set by user. */
 		{1010, NULL, NULL, NULL, NULL, NULL, NULL, NULL,},
 		/* 1011/rxvt: disallowed, scroll-on-keypress is set by user. */
-- 
2.3.0

